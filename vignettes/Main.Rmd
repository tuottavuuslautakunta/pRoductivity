---
title: "Päätoimialat"
author: "Janne Huovari"
date: "`r Sys.Date()`"
output: rmarkdown::html_document

---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  fig.path = "fig_intro/",
  collapse = TRUE,
  comment = "#>"
)

devtools::load_all()

library(tidyverse)
library(ggptt)

set_ptt()

# Data

data("dat_stan_main", "dat_nama_main")

eurostat_countries <- c("FI", "SE", "DE", "UK", "FR", "DK", "IT", "NL", "NO", "EU15")
start_time <- 2000
base_year <- 2008



dat_main <- 
  dat_nama_main %>% 
  select(- B1G__CLV10_MEUR) %>% 
  filter(geo %in% eurostat_countries) %>% 
  bind_rows(filter(dat_stan_main, time >= min(dat_nama_main$time))) %>% 
  filter(time >= start_time)

dat_main_groups <- dat_main %>% 
  gather(vars, values, -time, - geo, - nace_r2) %>% 
  group_by(geo, time, vars) %>% 
  summarise(private = sum(values),
            manu = sum(values[nace_r2 == "C"]),
            service = sum(values[nace_r2 %in% c(c("G", "H", "I", "J", "M", "N"))])) %>% 
  ungroup() %>% 
  gather(nace0, values, private, manu, service) %>% 
  spread(vars, values) %>% 
  group_by(geo, nace0) %>% 
  # volyymia ei voi laskea yhteen, täytyy laske cp ja pp sarjoista
  mutate(b1g__clv10_mnac = statfitools::fp(cp = B1G__CP_MNAC, pp = B1G__PYP_MNAC, time = time, year = 2010),
         lp_10 = b1g__clv10_mnac / EMP_DC__THS_HW,
         lp_ind = 100 * lp_10/lp_10[time == base_year]) %>% 
  ungroup()


```


```{r lp}

dat_main_groups %>% 
  ggplot(aes(time, lp_ind, colour = geo)) +
  facet_wrap(~ nace0) +
  geom_line()

```

