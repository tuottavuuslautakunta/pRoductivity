---
title: "SSCA"
author: "Janne Huovari"
date: "8 11 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

devtools::load_all()
library(here)
library(tidyverse)

est_periods <- 1996:2007
eval_periods <- 2008:2016
all_periods <- c(est_periods, eval_periods)

data(data_main_groups)

ssca_dat <- data_main_groups %>% 
  complete(geo, nace0, time) %>% 
  group_by(geo, nace0) %>% 
  mutate(lp_ind =  100 * lp_ind/lp_ind[time == 1997]) %>% 
  ungroup()

```

```{r, eval=FALSE, include=FALSE}


######################
### SSCA - Example ###
######################

#Data should be provided in the same format as the example dataset below:

#(1) Long format
#(2) No missing values

data <- readRDS(here("data/ssca_data_example.rds"))


data %>% 
  filter(geo == "FI") %>% 
  mutate(V_FP = statfitools::fp(V_CP, V_PYP, year, 2010),
         LP = V_FP / L) %>% 
  # select(geo, year, LP, d_LP, cvol_LP) %>% 
  gather(vars, values, -geo, -year) %>% 
  ggplot(aes(year, values)) +
  facet_wrap(~ vars, scales = "free") +
  geom_line()



```

```{r demo}
###########################
### Deploying the model ###
###########################




z.list <- data %>% 
  data.frame() %>% 
  z.prep(unit_var = "geo",
                 target_unit = "FI",
                 value_var = "cvol_LP",
                 time_var = "year",
                 intervention = eval_periods[1],
                 first_date = 1996,
                 last_date = eval_periods[length(eval_periods)],
                 start_date = est_periods[1],
                 normalize = "no",
                 drop_countries = c())


#Estimating the model
w.list <- w.opt(z.list)

#Leave-one-out' robustness check
loo.obj <- loo.fun(z.list)


###############
### Results ###
###############

### Country weights ###
W_star <- w.list$W_star
W_star
#OR
round(W_star,2)[which(round(W_star,2) != 0)]

### Normalized RMSE Loss ###
comp.rmse(z.list, W_star)

#############
### Plots ###
#############

z.list$Z0

the_title <- "Yksityinen sektori"

plot.fit(z.list, 
         W_star, 
         start_date = est_periods[1], 
         title = the_title, 
         intervention_date = eval_periods[1]-1,
         LOO = loo.obj, 
         legend_arg = c("Suomi", "Synteettinen kontrolli", "Yksi maa jätetty pois maajoukosta")
         )

plot.diff(z.list, 
          W_star, 
          intervention = eval_periods[1]-1, 
          title = the_title, 
          history = TRUE, 
          LOO = loo.obj, 
          scale = 32,
          legend_arg = c("Suomi", "Synteettinen kontrolli", "Yksi maa jätetty pois maajoukosta"))




```

# Yksityinen sektori

```{r private}
###########################
### Deploying the model ###
###########################




z.list <- ssca_dat %>% 
  filter(nace0 == "private") %>% 
  data.frame() %>% 
  z.prep(unit_var = "geo",
                 target_unit = "FI",
                 value_var = "lp_ind",
                 time_var = "time",
                 intervention = eval_periods[1],
                 first_date = 1996,
                 last_date = eval_periods[length(eval_periods)],
                 start_date = est_periods[1],
                 normalize = "no",
                 drop_countries = c())


#Estimating the model
w.list <- w.opt(z.list)

#Leave-one-out' robustness check
loo.obj <- loo.fun(z.list)


###############
### Results ###
###############

### Country weights ###
W_star <- w.list$W_star
W_star
#OR
round(W_star,2)[which(round(W_star,2) != 0)]

### Normalized RMSE Loss ###
comp.rmse(z.list, W_star)

#############
### Plots ###
#############

the_title <- "Yksityinen sektori"

plot.fit(z.list, 
         W_star, 
         start_date = est_periods[1], 
         title = the_title, 
         intervention_date = eval_periods[1]-1,
         LOO = loo.obj, 
         legend_arg = c("Suomi", "Synteettinen kontrolli", "Yksi maa jätetty pois maajoukosta")
         )

plot.diff(z.list, 
          W_star, 
          intervention = eval_periods[1]-1, 
          title = the_title, 
          history = TRUE, 
          LOO = loo.obj, 
          scale = 32,
          legend_arg = c("Suomi", "Synteettinen kontrolli", "Yksi maa jätetty pois maajoukosta"))




```


# Teollisuus

```{r manu}
###########################
### Deploying the model ###
###########################

z.list <- ssca_dat %>% 
  filter(nace0 == "manu") %>% 
  data.frame() %>% 
  z.prep(unit_var = "geo",
                 target_unit = "FI",
                 value_var = "lp_ind",
                 time_var = "time",
                 intervention = eval_periods[1],
                 first_date = 1996,
                 last_date = eval_periods[length(eval_periods)],
                 start_date = est_periods[1],
                 normalize = "no",
                 drop_countries = c())


#Estimating the model
w.list <- w.opt(z.list)

#Leave-one-out' robustness check
loo.obj <- loo.fun(z.list)


###############
### Results ###
###############

### Country weights ###
W_star <- w.list$W_star
W_star
#OR
round(W_star,2)[which(round(W_star,2) != 0)]

### Normalized RMSE Loss ###
comp.rmse(z.list, W_star)

#############
### Plots ###
#############

the_title <- "Teollisuus"

plot.fit(z.list, 
         W_star, 
         start_date = est_periods[1], 
         title = the_title, 
         intervention_date = eval_periods[1]-1,
         LOO = loo.obj, 
         legend_arg = c("Suomi", "Synteettinen kontrolli", "Yksi maa jätetty pois maajoukosta")
         )

plot.diff(z.list, 
          W_star, 
          intervention = eval_periods[1]-1, 
          title = the_title, 
          history = TRUE, 
          LOO = loo.obj, 
          scale = 32,
          legend_arg = c("Suomi", "Synteettinen kontrolli", "Yksi maa jätetty pois maajoukosta"))

```

# Palvelut

```{r service}
###########################
### Deploying the model ###
###########################

z.list <- ssca_dat %>% 
  filter(nace0 == "service") %>% 
  data.frame() %>% 
  z.prep(unit_var = "geo",
                 target_unit = "FI",
                 value_var = "lp_ind",
                 time_var = "time",
                 intervention = eval_periods[1],
                 first_date = 1996,
                 last_date = eval_periods[length(eval_periods)],
                 start_date = est_periods[1],
                 normalize = "no",
                 drop_countries = c())


#Estimating the model
w.list <- w.opt(z.list)

#Leave-one-out' robustness check
loo.obj <- loo.fun(z.list)


###############
### Results ###
###############

### Country weights ###
W_star <- w.list$W_star
W_star
#OR
round(W_star,2)[which(round(W_star,2) != 0)]

### Normalized RMSE Loss ###
comp.rmse(z.list, W_star)

#############
### Plots ###
#############

the_title <- "Palvelut"

plot.fit(z.list, 
         W_star, 
         start_date = est_periods[1], 
         title = the_title, 
         intervention_date = eval_periods[1]-1,
         LOO = loo.obj, 
         legend_arg = c("Suomi", "Synteettinen kontrolli", "Yksi maa jätetty pois maajoukosta")
         )

plot.diff(z.list, 
          W_star, 
          intervention = eval_periods[1]-1, 
          title = the_title, 
          history = TRUE, 
          LOO = loo.obj, 
          scale = 32,
          legend_arg = c("Suomi", "Synteettinen kontrolli", "Yksi maa jätetty pois maajoukosta"))

```
